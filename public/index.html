<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Octopus Energy IHD (Virtual In Home Display)</title>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css"
        integrity="sha512-8vq2g5nHE062j3xor4XxPeZiPjmRDh6wlufQlfC6pdQ/9urJkU07NM0tEREeymP++NczacJ/Q59ul+/K2eYvcg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.css"
        integrity="sha512-0w74+CBOlTu44j+e8dSKFl/5Qg9JoJhfK7Gf/+5bdtzJgqP7N3+02W02rQqRrywlm8cKXg3YwQWMBIS18GYPZg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body id="body" class="hold-transition login-page">
    <div id="login-box" class="login-box">

        <div class="card card-outline card-primary">
            <div class="card-header text-center">
                <a href="#" class="h2"><b>Octopus Energy</b> IHD</a>
            </div>
            <div class="card-body">
                <p class="login-box-msg">Sign in with your <b>Octopus Energy</b> credentials to continue</p>
                <form onsubmit="loginFormSubmit(); return false" method="post">
                    <div class="input-group mb-3">
                        <input type="email" id="login-email" class="form-control" placeholder="Email">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-envelope"></span>
                            </div>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="password" id="login-password" class="form-control" placeholder="Password">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-lock"></span>
                            </div>
                        </div>
                    </div>

                    <div class="social-auth-links text-center mt-2 mb-3">
                        <button id="login-submit" type="submit" class="btn btn-primary btn-block">Sign In</button>
                    </div>

                </form>
            </div>

        </div>

    </div>

    <div id="ihd-page" class="wrapper d-none">

        <nav class="main-header navbar navbar-expand navbar-white navbar-light">

            <ul class="navbar-nav">

                <li class="nav-item">
                    <a href="#" class="nav-link" style="color: #000000;"><b>Octopus Energy</b></a>
                </li>

                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" id="octopus-user-fullname" class="nav-link" style="color: #000000;">John Doe</a>
                </li>

            </ul>

            <ul class="navbar-nav ml-auto">

                <li class="nav-item">
                    <a href="#" id="octopus-account-ref" class="nav-link" style="color: #000000;"><b>A-B12C3D45</b></a>
                </li>

            </ul>
        </nav>

        <div class="content-wrapper" style="padding: 15px; min-height: 1604.44px;">

            <section class="content">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card card-success">
                            <div class="card-header">
                                <h3 class="card-title">Live Usage</h3>
                            </div>

                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6" style="height:200px;width:100%">
                                        <div style="position:relative;width:210px;margin:auto">
                                            <div style="position:absolute;left:15px;top:10px">
                                                <input class="knob" id="live-usage" data-angleOffset=-125 data-angleArc=250 data-fgColor="#66EE66" data-min="0" data-max="10000" value="650" data-displayInput=false data-width="180" data-height="180" data-readOnly=true>
                                            </div>
                                            <div style="position:absolute;left:78px;top:65px" id="live-usage-icon">
                                                <i class="fa-solid fa-bolt" style="font-size: 4rem;"></i>
                                            </div>
                                            <!--<div style="position:absolute;left:110px;top:110px">
                                                <input class="knob second" data-min="0" data-max="60" data-bgColor="#333" data-fgColor="rgb(127, 255, 0)" data-displayInput=false data-width="100" data-height="100" data-thickness=".3">
                                            </div>-->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="d-none d-md-block col-md-12 text-right" style="font-size: 2.5rem; height:35px;">
                                                &nbsp;
                                            </div>
                                            <div id="live-usage-total" class="col-md-12 text-center text-md-right m-md-0" style="font-size: 2.5rem; height:50px; margin-top: -45px;">
                                                7.48 kW
                                            </div>
                                            <div id="live-usage-cost" class="col-md-12 text-center text-md-right" style="font-size: 2.5rem; height:50px;">
                                                £ 0.00 / hr
                                            </div>
                                            <div class="d-none d-md-block col-md-12 text-right" style="font-size: 2.5rem; height:25px;">
                                                &nbsp;
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </section>

        </div>

        <footer class="main-footer">
            <div class="float-right d-none d-sm-block">
                <b>Version</b> 0.0.1
            </div>
            <strong>Copyright © 2023 <a href="https://github.com/iamacarpet/octopus-ihd">iamacarpet</a>.</strong> All
            rights reserved.
        </footer>

    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"
        integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"
        integrity="sha512-mULnawDVcCnsk9a4aG1QLZZ6rcce/jSzEGqUkeOLy0b6q0+T6syHrxlsAGH7ZVoqC93Pd0lBqd6WguPWih7VHA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"
        integrity="sha512-KBeR1NhClUySj9xBB0+KRqYLPkM6VvXiiWaSz/8LCQNdRpUm38SWUrj0ccNDNSkwCD9qPA4KobLliG26yPppJA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.2/luxon.min.js" integrity="sha512-TETg2zvTcaOsvJIMUqb8NA7XzoqyT709S0hcriUF2cWtJlM0WQsq6Vk/0EjaeDW8lsceYp5UB9iq8VUTzwMwLQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-Knob/1.2.13/jquery.knob.min.js"
        integrity="sha512-NhRZzPdzMOMf005Xmd4JonwPftz4Pe99mRVcFeRDcdCtfjv46zPIi/7ZKScbpHD/V0HB1Eb+ZWigMqw94VUVaw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        $(function ($) {

            $(".knob").knob({
                change: function (value) {
                    //console.log("change : " + value);
                },
                release: function (value) {
                    //console.log(this.$.attr('value'));
                    console.log("release : " + value);
                },
                cancel: function () {
                    console.log("cancel : ", this);
                },
                /*format : function (value) {
                 return value + '%';
                 },*/
                draw: function () {

                    // "tron" case
                    if (this.$.data('skin') == 'tron') {

                        this.cursorExt = 0.3;

                        var a = this.arc(this.cv)  // Arc
                            , pa                   // Previous arc
                            , r = 1;

                        this.g.lineWidth = this.lineWidth;

                        if (this.o.displayPrevious) {
                            pa = this.arc(this.v);
                            this.g.beginPath();
                            this.g.strokeStyle = this.pColor;
                            this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, pa.s, pa.e, pa.d);
                            this.g.stroke();
                        }

                        this.g.beginPath();
                        this.g.strokeStyle = r ? this.o.fgColor : this.fgColor;
                        this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, a.s, a.e, a.d);
                        this.g.stroke();

                        this.g.lineWidth = 2;
                        this.g.beginPath();
                        this.g.strokeStyle = this.o.fgColor;
                        this.g.arc(this.xy, this.xy, this.radius - this.lineWidth + 1 + this.lineWidth * 2 / 3, 0, 2 * Math.PI, false);
                        this.g.stroke();

                        return false;
                    }
                }
            });

            /*setTimeout(function(){
                $('#live-usage').val(1200).trigger("change").trigger('configure', {'fgColor': '#dc3545'});
            }, 5000);*/

        });
    </script>

    <script>
        var DateTime = luxon.DateTime;

        var username = false;
        var password = false;

        var token = false;

        var globalData = {
            account: null,

            meters: null,

            currentDemand: null
        }

        $.gql = async function (query, includeAuthentication = true) {
            var headers = {};

            if (includeAuthentication) {
                headers = {
                    "Authorization": await fetchToken()
                };
            }

            return new Promise((resolve, reject) => {
                $.ajax({
                    url: "https://api.octopus.energy/v1/graphql/",
                    method: 'POST',
                    headers: headers,
                    data: JSON.stringify(query),
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    success: resolve,
                    error: reject
                });
            });
        }

        async function fetchUserInfo() {
            result = await $.gql({
                "operationName": "viewer",
                "query": `query viewer {
                        viewer {
                            fullName
                            accounts {
                                number
                            }
                        }
                    }`
            });

            console.log(result.data.viewer);

            return result.data.viewer;
        }

        async function fetchMeterInformation() {
            result = {
                "electricity": {
                    "import": null,
                    "export": null
                },
                "gas": null
            };

            rresult = await $.gql({
                "operationName": "GetTariffDetails",
                "query": `query GetTariffDetails($accountNumber: String!) {
                    properties(accountNumber: $accountNumber, active: true) {
                        electricityMeterPoints {
                            mpan
                            meters(includeInactive: false) {
                                ...ElectricityMeter
                            }
                        }
                    }
                }

                fragment Device on SmartMeterDeviceType {
                    deviceId
                }

                fragment ElectricityMeter on ElectricityMeterType {
                    installationDate
                    serialNumber
                    consumptionUnits
                    meterPoint {
                        mpan
                    }
                    smartImportElectricityMeter {
                        ...Device
                        deviceId
                    }
                    smartExportElectricityMeter {
                        ...Device
                        deviceId
                    }
                }`,
                "variables": { "accountNumber": globalData.accountInfo.accounts[0].number }
            });

            rresult.data.properties[0].electricityMeterPoints.forEach(function (emeter) {
                if (emeter.meters[0].smartImportElectricityMeter != null) {
                    result.electricity.import = {
                        "mpan": emeter.mpan,
                        "consumptionUnits": emeter.meters[0].consumptionUnits,
                        "deviceId": emeter.meters[0].smartImportElectricityMeter.deviceId
                    }
                } else if (emeter.meters[0].smartExportElectricityMeter != null) {
                    result.electricity.export = {
                        "mpan": emeter.mpan,
                        "consumptionUnits": emeter.meters[0].consumptionUnits,
                        "deviceId": emeter.meters[0].smartExportElectricityMeter.deviceId
                    }
                }
            });

            return result;
        }

        async function getCurrentDemand() {
            result = await $.gql({
                "operationName": "GetSmartMeterTelemetry",
                "variables": {
                    "deviceID": globalData.meters.electricity.import.deviceId,
                    "startDate": DateTime.now().minus({minutes: 3}).toISO(),
                    "endDate": DateTime.now().plus({minutes: 1}).toISO(),
                    "grouping": "TEN_SECONDS"
                },
                "query": `query GetSmartMeterTelemetry($deviceID: String!, $startDate: DateTime!, $endDate: DateTime!, $grouping: TelemetryGrouping!) {
                    smartMeterTelemetry(
                        deviceId: $deviceID
                        start: $startDate
                        end: $endDate
                        grouping: $grouping
                    ) {
                        readAt
                        consumption
                        demand
                        consumptionDelta
                        costDelta
                    }
                }`
            });

            recent = result.data.smartMeterTelemetry.slice(-1);

            return recent[0].demand;
        }

        async function fetchToken() {
            if (token != false) {
                var decoded = jwt_decode(token);

                if (decoded.exp < (getTimestampInSeconds() + 60)) {
                    console.log('Authentication token expired, renewing...');

                    await performLogin();
                }

                return token;
            } else {
                console.error("Invalid Token");
                return false;
            }
        }

        async function performLogin(u, p) {
            if (arguments.length == 2) {
                username = u;
                password = p;
            }

            console.log('Performing login as ' + username);

            result = await $.gql({
                "operationName": "krakenTokenAuthentication",
                "query": `mutation krakenTokenAuthentication($email: String!, $password: String!) {
                        obtainKrakenToken(input: {email: $email, password: $password}) {
                            token
                        }
                    }`,
                "variables": {
                    "email": username,
                    "password": password,
                }
            }, false);

            token = result.data.obtainKrakenToken.token;

            console.log('Successfully obtained token: ' + token);
        }

        async function loginFormSubmit() {
            $('#login-submit').prop('disabled', true);
            $('#login-submit').html('<i class="fa-solid fa-cog fa-spin"></i>');

            setTimeout(async function () {
                try {
                    await performLogin(
                        $('#login-email').val(),
                        $('#login-password').val()
                    );
                } catch (e) {
                    $('#login-submit').removeClass('btn-primary');
                    $('#login-submit').addClass('btn-danger');
                    $('#login-submit').html('FAILED');
                    console.log('LOGIN FAILED');

                    setTimeout(function () {
                        $('#login-submit').removeClass('btn-danger');
                        $('#login-submit').addClass('btn-primary');
                        $('#login-submit').html('Sign In');
                        $('#login-submit').prop('disabled', false);
                    }, 1000);

                    return;
                }

                globalData.accountInfo = await fetchUserInfo();

                $('#octopus-user-fullname').html(globalData.accountInfo.fullName);
                $('#octopus-account-ref').html(globalData.accountInfo.accounts[0].number);

                globalData.meters = await fetchMeterInformation();
                console.log(globalData.meters);

                await performRefresh();

                $('#login-box').addClass('d-none');

                $('#body').removeClass('hold-transition');
                $('#body').removeClass('login-page');

                $('#body').addClass('layout-top-nav');
                $('#body').attr('style', "height: auto;");

                $('#ihd-page').removeClass('d-none');
            }, 500);
        }

        async function setupRefresh() {
            setTimeout(performRefresh, (1000 * 10));
        }

        async function performRefresh() {
            globalData.currentDemand = await getCurrentDemand();
            console.log("Current Demand: " + globalData.currentDemand + " W");

            var demand = globalData.currentDemand;
            if (demand < 0) {
                demand = demand * -1;
                $('#live-usage-icon').html('<i class="fa-solid fa-charging-station" style="font-size: 3.5rem;"></i>');
                $('#live-usage').trigger('configure', {'fgColor': '#17a2b8'});
                $('#live-usage-cost').html('+£ 0.00 / hr');
            } else {
                $('#live-usage-icon').html('<i class="fa-solid fa-bolt" style="font-size: 4rem;"></i>');

                var color = '#28a745';
                if (demand > 5000) {
                    color = '#dc3545';
                } else if (demand > 1500) {
                    color = '#ffc107';
                }
                $('#live-usage').trigger('configure', {'fgColor': color});

                $('#live-usage-cost').html('£ 0.00 / hr');
            }

            $('#live-usage').val(demand).trigger("change");

            var usage = demand + " W";
            if (demand > 1000) {
                usage = (demand / 1000) + " kW";
            }
            $('#live-usage-total').html(usage);

            setupRefresh();
        }

        function getTimestampInSeconds() {
            return Math.floor(Date.now() / 1000)
        }
    </script>

</body>

</html>